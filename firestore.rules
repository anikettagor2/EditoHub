rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper Functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function hasRole(role) {
      return isAuthenticated() && getUserData().role == role;
    }
    
    function isAdmin() {
      return hasRole('admin');
    }
    
    function isManager() {
      return hasRole('manager');
    }

    function isAdminOrManager() {
      return isAdmin() || isManager();
    }
    
    // Users Collection
    match /users/{userId} {
      // Users can read/write their own data
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
      // Admins/Managers can read all users (for dashboard)
      allow read: if isAdminOrManager();
      // Admins can delete users
      allow delete: if isAdmin();
    }
    
    // Projects Collection
    match /projects/{projectId} {
      // Admin/Manager have full access
      allow create: if isAdminOrManager();
      allow delete: if isAdmin(); // Only admin can delete
      
      // Update: Admin/Manager can update all. 
      // Assigned Editor/Members can update specific fields ideally, but for now we allow update if member.
      // (Refinement: restrict critical fields for non-admins if needed, but 'status' updates etc are common)
      allow update: if isAdminOrManager() || 
                    (isAuthenticated() && (
                      resource.data.assignedEditorId == request.auth.uid || 
                      request.auth.uid in resource.data.members ||
                      resource.data.ownerId == request.auth.uid
                    ));
                    
      // Read: Admin/Manager can read all. 
      // Others must be Owner, Assigned Editor, or Member.
      allow read: if isAdminOrManager() || 
                  (isAuthenticated() && (
                    resource.data.assignedEditorId == request.auth.uid || 
                    request.auth.uid in resource.data.members || 
                    resource.data.ownerId == request.auth.uid
                  ));
                  
      // Nested Collections (comments, revisions, etc.)
      match /{subcollection=**} {
         allow read, write: if isAdminOrManager() || 
                  (isAuthenticated() && (
                    get(/databases/$(database)/documents/projects/$(projectId)).data.assignedEditorId == request.auth.uid || 
                    request.auth.uid in get(/databases/$(database)/documents/projects/$(projectId)).data.members ||
                    get(/databases/$(database)/documents/projects/$(projectId)).data.ownerId == request.auth.uid
                  ));
      }
    }
  }
}
